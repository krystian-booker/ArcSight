<div
    class="pipeline-form surface stack stack-xl"
    x-show="pipelineType === 'AprilTag'"
    x-transition
    x-cloak
>
    <header class="stack stack-xs">
        <h3>AprilTag Configuration</h3>
        <p class="panel-hint">Fine-tune detection thresholds and pose solver depth for reliable tag localisation.</p>
    </header>
    <div class="grid-2">
        <div class="stack stack-lg">
            <div class="form-field">
                <label class="form-label" title="The family of AprilTags to detect.">Target Family</label>
                <select
                    class="form-control"
                    x-model="pipelineForms.apriltag.family"
                    @change="queuePipelineSave"
                >
                    <option value="tag36h11">36h11</option>
                    <option value="tag16h5">16h5</option>
                    <option value="tag25h9">25h9</option>
                    <option value="tagCircle21h7">Circle21h7</option>
                </select>
            </div>
            <div class="form-field">
                <label class="form-label" title="Physical size of the tag in metres.">Tag Size (m)</label>
                <input
                    type="number"
                    step="0.001"
                    class="form-control"
                    x-model.number="pipelineForms.apriltag.tag_size_m"
                    @change.debounce.300="queuePipelineSave"
                >
            </div>
            <div class="form-field">
                <label class="form-label" title="Number of CPU threads to use for detection.">Threads (1-8)</label>
                <div class="cluster">
                    <input
                        type="range"
                        min="1"
                        max="8"
                        step="1"
                        class="form-range"
                        x-model.number="pipelineForms.apriltag.threads"
                        @input.debounce.300="queuePipelineSave"
                    >
                    <input
                        type="number"
                        min="1"
                        max="8"
                        step="1"
                        class="form-control form-control--small"
                        x-model.number="pipelineForms.apriltag.threads"
                        @change.debounce.300="queuePipelineSave"
                    >
                </div>
            </div>
            <div class="form-field">
                <label class="form-label" title="Decimates the input image to boost performance.">Decimate (1-8)</label>
                <div class="cluster">
                    <input
                        type="range"
                        min="1"
                        max="8"
                        step="0.1"
                        class="form-range"
                        x-model.number="pipelineForms.apriltag.decimate"
                        @input.debounce.300="queuePipelineSave"
                    >
                    <input
                        type="number"
                        min="1"
                        max="8"
                        step="0.1"
                        class="form-control form-control--small"
                        x-model.number="pipelineForms.apriltag.decimate"
                        @change.debounce.300="queuePipelineSave"
                    >
                </div>
            </div>
            <div class="form-field">
                <label class="form-label" title="Applies a Gaussian blur before detection to reduce noise.">Blur (0-5)</label>
                <div class="cluster">
                    <input
                        type="range"
                        min="0"
                        max="5"
                        step="0.1"
                        class="form-range"
                        x-model.number="pipelineForms.apriltag.blur"
                        @input.debounce.300="queuePipelineSave"
                    >
                    <input
                        type="number"
                        min="0"
                        max="5"
                        step="0.1"
                        class="form-control form-control--small"
                        x-model.number="pipelineForms.apriltag.blur"
                        @change.debounce.300="queuePipelineSave"
                    >
                </div>
            </div>
            <div class="form-field">
                <label class="form-label" title="Minimum decision margin required to accept a detection.">Decision Margin Cutoff (0-250)</label>
                <div class="cluster">
                    <input
                        type="range"
                        min="0"
                        max="250"
                        step="1"
                        class="form-range"
                        x-model.number="pipelineForms.apriltag.decision_margin"
                        @input.debounce.300="queuePipelineSave"
                    >
                    <input
                        type="number"
                        min="0"
                        max="250"
                        step="1"
                        class="form-control form-control--small"
                        x-model.number="pipelineForms.apriltag.decision_margin"
                        @change.debounce.300="queuePipelineSave"
                    >
                </div>
            </div>
            <div class="form-field">
                <label class="form-label" title="The minimum weight required to accept a tag detection.">Min Detection Weight</label>
                <div class="cluster">
                    <input
                        type="range"
                        min="0"
                        max="300"
                        step="1"
                        class="form-range"
                        x-model.number="pipelineForms.apriltag.min_weight"
                        @input.debounce.300="queuePipelineSave"
                    >
                    <input
                        type="number"
                        min="0"
                        max="300"
                        step="1"
                        class="form-control form-control--small"
                        x-model.number="pipelineForms.apriltag.min_weight"
                        @change.debounce.300="queuePipelineSave"
                    >
                </div>
            </div>
            <div class="form-field">
                <label class="form-label" title="Rejects tags that partially leave the frame to reduce false positives.">Edge Reject Threshold (0-1)</label>
                <div class="cluster">
                    <input
                        type="range"
                        min="0"
                        max="1"
                        step="0.05"
                        class="form-range"
                        x-model.number="pipelineForms.apriltag.edge_threshold"
                        @input.debounce.300="queuePipelineSave"
                    >
                    <input
                        type="number"
                        min="0"
                        max="1"
                        step="0.05"
                        class="form-control form-control--small"
                        x-model.number="pipelineForms.apriltag.edge_threshold"
                        @change.debounce.300="queuePipelineSave"
                    >
                </div>
            </div>
            <div class="form-field">
                <label class="form-label" title="Controls the depth of the AprilTag pose solver.">Pose Iterations (0-500)</label>
                <div class="cluster">
                    <input
                        type="range"
                        min="0"
                        max="500"
                        step="1"
                        class="form-range"
                        x-model.number="pipelineForms.apriltag.pose_iterations"
                        @input.debounce.300="queuePipelineSave"
                    >
                    <input
                        type="number"
                        min="0"
                        max="500"
                        step="1"
                        class="form-control form-control--small"
                        x-model.number="pipelineForms.apriltag.pose_iterations"
                        @change.debounce.300="queuePipelineSave"
                    >
                </div>
            </div>
            <label class="cluster text-small">
                <input
                    type="checkbox"
                    class="form-checkbox"
                    x-model="pipelineForms.apriltag.refine_edges"
                    @change="queuePipelineSave"
                >
                <span title="Refines tag edges for more accurate pose estimation.">Refine edges</span>
            </label>
        </div>

        <div class="stack stack-lg">
            <div class="stack stack-sm">
                <h4>Live Targets</h4>
                <div style="overflow-x:auto;">
                    <table class="table table--compact">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>X (m)</th>
                                <th>Y (m)</th>
                                <th>Z (m)</th>
                                <th>Yaw (°)</th>
                                <th>Pitch (°)</th>
                                <th>Roll (°)</th>
                                <th>Error</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="(target, index) in results.apriltag" :key="target.id ?? index">
                                <tr>
                                    <td x-text="target.id ?? index"></td>
                                    <td x-text="formatNumber(target.x_m, 3)"></td>
                                    <td x-text="formatNumber(target.y_m, 3)"></td>
                                    <td x-text="formatNumber(target.z_m, 3)"></td>
                                    <td x-text="formatNumber(target.yaw_deg, 2)"></td>
                                    <td x-text="formatNumber(target.pitch_deg, 2)"></td>
                                    <td x-text="formatNumber(target.roll_deg, 2)"></td>
                                    <td x-text="formatNumber(target.pose_error, 4)"></td>
                                </tr>
                            </template>
                            <tr x-show="!results.apriltag.length">
                                <td colspan="8" class="muted text-center text-small">No targets detected</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="surface stack stack-sm" x-show="results.multiTag" x-cloak style="border-color: rgba(0, 194, 168, 0.16);">
                <h4>Multi-Tag Pose</h4>
                <div class="grid-2 grid-tight text-small">
                    <div><span class="muted">Tags used:</span> <span x-text="(results.multiTag?.tag_ids || []).length || '0'"></span></div>
                    <div><span class="muted">Error:</span> <span x-text="formatNumber(results.multiTag?.pose_error, 4)"></span></div>
                    <div><span class="muted">X (m):</span> <span x-text="formatNumber(results.multiTag?.x_m, 3)"></span></div>
                    <div><span class="muted">Y (m):</span> <span x-text="formatNumber(results.multiTag?.y_m, 3)"></span></div>
                    <div><span class="muted">Z (m):</span> <span x-text="formatNumber(results.multiTag?.z_m, 3)"></span></div>
                    <div><span class="muted">Yaw (°):</span> <span x-text="formatNumber(results.multiTag?.yaw_deg, 2)"></span></div>
                    <div><span class="muted">Pitch (°):</span> <span x-text="formatNumber(results.multiTag?.pitch_deg, 2)"></span></div>
                    <div><span class="muted">Roll (°):</span> <span x-text="formatNumber(results.multiTag?.roll_deg, 2)"></span></div>
                </div>
            </div>
        </div>
    </div>
</div>
