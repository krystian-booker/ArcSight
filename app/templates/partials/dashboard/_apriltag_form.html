<div
    class="pipeline-form"
    x-show="pipelineType === 'AprilTag'"
    x-transition
    x-cloak
>
    <h3 class="text-lg font-bold mb-4">AprilTag Configuration</h3>
    <div class="flex flex-wrap md:flex-nowrap gap-4">
        <div class="w-full md:w-1/2 space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2" title="The family of AprilTags to detect.">Target Family</label>
                <select
                    class="custom-select w-full"
                    x-model="pipelineForms.apriltag.family"
                    @change="queuePipelineSave"
                >
                    <option value="tag36h11">36h11</option>
                    <option value="tag16h5">16h5</option>
                    <option value="tag25h9">25h9</option>
                    <option value="tagCircle21h7">Circle21h7</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2" title="Physical size of the tag in metres.">Tag Size (m)</label>
                <input
                    type="number"
                    step="0.001"
                    class="custom-select w-full"
                    x-model.number="pipelineForms.apriltag.tag_size_m"
                    @change.debounce.300="queuePipelineSave"
                >
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2" title="Number of CPU threads to use for detection.">Threads (1-8)</label>
                <div class="flex items-center gap-4">
                    <input
                        type="range"
                        min="1"
                        max="8"
                        step="1"
                        class="w-full"
                        x-model.number="pipelineForms.apriltag.threads"
                        @input.debounce.300="queuePipelineSave"
                    >
                    <input
                        type="number"
                        min="1"
                        max="8"
                        step="1"
                        class="w-24 custom-select"
                        x-model.number="pipelineForms.apriltag.threads"
                        @change.debounce.300="queuePipelineSave"
                    >
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2" title="Decimates the input image to boost performance.">Decimate (1-8)</label>
                <div class="flex items-center gap-4">
                    <input
                        type="range"
                        min="1"
                        max="8"
                        step="0.1"
                        class="w-full"
                        x-model.number="pipelineForms.apriltag.decimate"
                        @input.debounce.300="queuePipelineSave"
                    >
                    <input
                        type="number"
                        min="1"
                        max="8"
                        step="0.1"
                        class="w-24 custom-select"
                        x-model.number="pipelineForms.apriltag.decimate"
                        @change.debounce.300="queuePipelineSave"
                    >
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2" title="Applies a Gaussian blur before detection to reduce noise.">Blur (0-5)</label>
                <div class="flex items-center gap-4">
                    <input
                        type="range"
                        min="0"
                        max="5"
                        step="0.1"
                        class="w-full"
                        x-model.number="pipelineForms.apriltag.blur"
                        @input.debounce.300="queuePipelineSave"
                    >
                    <input
                        type="number"
                        min="0"
                        max="5"
                        step="0.1"
                        class="w-24 custom-select"
                        x-model.number="pipelineForms.apriltag.blur"
                        @change.debounce.300="queuePipelineSave"
                    >
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2" title="Minimum decision margin required to accept a detection.">Decision Margin Cutoff (0-250)</label>
                <div class="flex items-center gap-4">
                    <input
                        type="range"
                        min="0"
                        max="250"
                        step="1"
                        class="w-full"
                        x-model.number="pipelineForms.apriltag.decision_margin"
                        @input.debounce.300="queuePipelineSave"
                    >
                    <input
                        type="number"
                        min="0"
                        max="250"
                        step="1"
                        class="w-24 custom-select"
                        x-model.number="pipelineForms.apriltag.decision_margin"
                        @change.debounce.300="queuePipelineSave"
                    >
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2" title="Number of iterations used during pose estimation.">Pose Estimation Iterations (0-500)</label>
                <div class="flex items-center gap-4">
                    <input
                        type="range"
                        min="0"
                        max="500"
                        step="1"
                        class="w-full"
                        x-model.number="pipelineForms.apriltag.pose_iterations"
                        @input.debounce.300="queuePipelineSave"
                    >
                    <input
                        type="number"
                        min="0"
                        max="500"
                        step="1"
                        class="w-24 custom-select"
                        x-model.number="pipelineForms.apriltag.pose_iterations"
                        @change.debounce.300="queuePipelineSave"
                    >
                </div>
            </div>
            <div class="flex items-center">
                <input
                    type="checkbox"
                    class="form-checkbox h-5 w-5 text-indigo-600"
                    x-model="pipelineForms.apriltag.refine_edges"
                    @change="queuePipelineSave"
                >
                <span class="ml-2 text-sm text-gray-300" title="Refines tag edges for more accurate pose estimation.">Refine Edges</span>
            </div>
        </div>

        <div class="w-full md:w-1/2">
            <h4 class="text-md font-bold mb-2">Live Targets</h4>
            <div class="overflow-x-auto rounded border border-gray-700">
                <table class="min-w-full divide-y divide-gray-700">
                    <thead class="bg-gray-700">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">ID</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">X (m)</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Y (m)</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Z (m)</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Yaw (°)</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Pitch (°)</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Roll (°)</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Error</th>
                        </tr>
                    </thead>
                    <tbody class="bg-gray-800 divide-y divide-gray-700">
                        <template x-for="(target, index) in results.apriltag" :key="target.id ?? index">
                            <tr>
                                <td class="px-4 py-2 text-sm text-gray-200" x-text="target.id ?? index"></td>
                                <td class="px-4 py-2 text-sm text-gray-300" x-text="formatNumber(target.x_m, 3)"></td>
                                <td class="px-4 py-2 text-sm text-gray-300" x-text="formatNumber(target.y_m, 3)"></td>
                                <td class="px-4 py-2 text-sm text-gray-300" x-text="formatNumber(target.z_m, 3)"></td>
                                <td class="px-4 py-2 text-sm text-gray-300" x-text="formatNumber(target.yaw_deg, 2)"></td>
                                <td class="px-4 py-2 text-sm text-gray-300" x-text="formatNumber(target.pitch_deg, 2)"></td>
                                <td class="px-4 py-2 text-sm text-gray-300" x-text="formatNumber(target.roll_deg, 2)"></td>
                                <td class="px-4 py-2 text-sm text-gray-300" x-text="formatNumber(target.pose_error, 4)"></td>
                            </tr>
                        </template>
                        <tr x-show="!results.apriltag.length">
                            <td colspan="8" class="px-4 py-4 text-center text-sm text-gray-500">No targets detected</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="mt-6" x-show="results.multiTag" x-cloak>
                <h4 class="text-md font-bold mb-2">Multi-Tag Pose</h4>
                <div class="bg-gray-900 rounded p-4 text-sm grid grid-cols-2 gap-2">
                    <div><span class="text-gray-400">Tags Used:</span> <span x-text="(results.multiTag?.tag_ids || []).length || '0'"></span></div>
                    <div><span class="text-gray-400">Error:</span> <span x-text="formatNumber(results.multiTag?.pose_error, 4)"></span></div>
                    <div><span class="text-gray-400">X (m):</span> <span x-text="formatNumber(results.multiTag?.x_m, 3)"></span></div>
                    <div><span class="text-gray-400">Y (m):</span> <span x-text="formatNumber(results.multiTag?.y_m, 3)"></span></div>
                    <div><span class="text-gray-400">Z (m):</span> <span x-text="formatNumber(results.multiTag?.z_m, 3)"></span></div>
                    <div><span class="text-gray-400">Yaw (°):</span> <span x-text="formatNumber(results.multiTag?.yaw_deg, 2)"></span></div>
                    <div><span class="text-gray-400">Pitch (°):</span> <span x-text="formatNumber(results.multiTag?.pitch_deg, 2)"></span></div>
                    <div><span class="text-gray-400">Roll (°):</span> <span x-text="formatNumber(results.multiTag?.roll_deg, 2)"></span></div>
                </div>
            </div>
        </div>
    </div>
</div>
