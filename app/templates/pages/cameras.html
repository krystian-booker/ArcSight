{% extends "layouts/base.html" %}
{% block title %}Cameras{% endblock %}
{% block content %}
<h1 class="text-3xl font-bold mb-4">Cameras</h1>


<!-- Camera Listing -->
<div class="bg-gray-800 rounded-lg p-4 mb-8">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold">Configured Cameras</h2>
        <button onclick="openAddModal()" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
            Add Camera
        </button>
    </div>
    <table class="min-w-full divide-y divide-gray-700">
        <thead class="bg-gray-700">
            <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Name</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Type</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Identifier</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Status</th>
                <th scope="col" class="relative px-6 py-3">
                    <span class="sr-only">Delete</span>
                </th>
            </tr>
        </thead>
        <tbody class="bg-gray-800 divide-y divide-gray-700">
            {% for camera in cameras %}
            <tr data-camera-id="{{ camera.id }}">
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-white">{{ camera.name }}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">{{ camera.camera_type }}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">{{ camera.identifier }}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm status-cell">
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-500 text-yellow-900">
                        Checking...
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    {% if camera.camera_type == 'GenICam' %}
                    <button type="button" class="text-indigo-400 hover:text-indigo-200 mr-4" onclick="toggleNodeDetails({{ camera.id }})">Nodes</button>
                    {% endif %}
                    <button class="text-indigo-500 hover:text-indigo-700 mr-4" onclick="openEditModal({{ camera.id }}, '{{ camera.name }}')">Edit</button>
                    <form action="{{ url_for('cameras.delete_camera', camera_id=camera.id) }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this camera?');" class="inline">
                        <button type="submit" class="text-red-500 hover:text-red-700">Delete</button>
                    </form>
                </td>
            </tr>
            {% if camera.camera_type == 'GenICam' %}
            <tr id="node-row-{{ camera.id }}" class="hidden bg-gray-900">
                <td colspan="5" class="px-6 py-4">
                    <div class="flex flex-col space-y-3">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
                            <div>
                                <h3 class="text-lg font-semibold text-white">GenICam Node Map</h3>
                                <p class="text-xs text-gray-400">Inspect and configure the camera's remote device parameters.</p>
                            </div>
                            <div class="flex flex-col sm:flex-row items-start sm:items-center gap-2">
                                <div class="relative flex-grow w-full sm:w-auto">
                                    <input type="text" id="node-search-{{ camera.id }}" placeholder="Quick Search..." class="w-full bg-gray-700 border border-gray-600 rounded-md text-white px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                </div>
                                <div class="flex items-center space-x-4">
                                    <label class="flex items-center text-sm text-gray-300">
                                        <input type="checkbox" id="node-show-all-{{ camera.id }}" class="rounded bg-gray-700 border-gray-600 text-indigo-600 shadow-sm focus:border-indigo-300 focus:ring focus:ring-offset-gray-800 focus:ring-indigo-200 focus:ring-opacity-50">
                                        <span class="ml-2">Show All</span>
                                    </label>
                                    <button type="button" onclick="refreshNodeMap({{ camera.id }})" class="inline-flex justify-center py-1.5 px-3 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                        Refresh
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div id="node-content-{{ camera.id }}" class="overflow-x-auto border border-gray-700 rounded-md bg-gray-800">
                            <div class="p-4 text-sm text-gray-400">Expand the row to load the node map for this camera.</div>
                        </div>
                    </div>
                </td>
            </tr>
            {% endif %}
            {% else %}
            <tr>
                <td colspan="5" class="px-6 py-4 whitespace-nowrap text-sm text-center text-gray-400">No cameras configured.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>


<!-- Add/Edit Camera Modal -->
<div id="camera-form-modal" class="fixed z-10 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <form id="camera-form" method="POST">
                <div class="bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <h3 class="text-lg leading-6 font-medium text-white" id="modal-title">Modal Title</h3>
                    
                    <div class="mt-4">
                        <label for="camera-name-modal" class="block text-sm font-medium text-gray-300">Name</label>
                        <input type="text" name="camera-name" id="camera-name-modal" required class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>

                    <div id="add-camera-fields" class="hidden">
                        <div class="mt-4">
                            <label for="camera-type-modal" class="block text-sm font-medium text-gray-300">Camera Type:</label>
                            <select id="camera-type-modal" name="camera-type" required class="custom-select">
                                <option value="">-- Select a Type --</option>
                                <option value="USB">Generic USB Camera</option>
                                {% if genicam_enabled %}
                                <option value="GenICam">GenICam</option>
                                {% endif %}
                                <option value="OAK-D">OAK-D Camera</option>
                            </select>
                        </div>
                
                        <!-- USB Camera Selection -->
                        <div id="usb-camera-section-modal" class="mt-4 hidden">
                            <label for="usb-camera-select-modal" class="block text-sm font-medium text-gray-300">Select USB Camera:</label>
                            <select id="usb-camera-select-modal" name="usb-camera-select" class="custom-select">
                                <!-- Options will be populated by JavaScript -->
                            </select>
                        </div>
                
                        <!-- GenICam Camera Selection -->
                        <div id="genicam-camera-section-modal" class="mt-4 hidden">
                            <label for="genicam-camera-select-modal" class="block text-sm font-medium text-gray-300">Select GenICam Camera:</label>
                            <select id="genicam-camera-select-modal" name="genicam-camera-select" class="custom-select">
                                <!-- Options will be populated by JavaScript -->
                            </select>
                        </div>

                        <!-- OAK-D Camera Selection -->
                        <div id="oakd-camera-section-modal" class="mt-4 hidden">
                            <label for="oakd-camera-select-modal" class="block text-sm font-medium text-gray-300">Select OAK-D Camera:</label>
                            <select id="oakd-camera-select-modal" name="oakd-camera-select" class="custom-select">
                                <!-- Options will be populated by JavaScript -->
                            </select>
                        </div>
                    </div>

                </div>
                <div class="bg-gray-900 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="submit" id="save-camera-button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:ml-3 sm:w-auto sm:text-sm disabled:opacity-50 disabled:cursor-not-allowed">Save</button>
                    <button type="button" onclick="closeModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-700 shadow-sm px-4 py-2 bg-gray-600 text-base font-medium text-white hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Camera Status Checking ---
    let statusInterval;

    function fetchCameraStatus(row) {
        const cameraId = row.dataset.cameraId;
        const statusCell = row.querySelector('.status-cell');
        // Keep "Checking..." status if it's the initial load
        const isInitialLoad = statusCell.textContent.includes('Checking...');

        fetch(`/cameras/status/${cameraId}`)
            .then(response => response.json())
            .then(data => {
                if (data.connected) {
                    statusCell.innerHTML = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-500 text-green-900">Connected</span>`;
                } else {
                    statusCell.innerHTML = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-500 text-red-900">Disconnected</span>`;
                }
            })
            .catch(error => {
                console.error('Error fetching camera status:', error);
                if (isInitialLoad) {
                    statusCell.innerHTML = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-500 text-gray-900">Error</span>`;
                }
                // If there's an error on subsequent polls, we can choose to leave the last known status
            });
    }

    function updateAllCameraStatuses() {
        const cameraRows = document.querySelectorAll('tr[data-camera-id]');
        cameraRows.forEach(fetchCameraStatus);
    }

    function startStatusUpdates() {
        // Clear any existing interval to prevent duplicates
        if (statusInterval) {
            clearInterval(statusInterval);
        }
        // Update statuses immediately and then start the interval
        updateAllCameraStatuses();
        statusInterval = setInterval(updateAllCameraStatuses, 5000); // Refresh every 5 seconds
    }

    function stopStatusUpdates() {
        if (statusInterval) {
            clearInterval(statusInterval);
            statusInterval = null;
        }
    }

    // Start updates when the page is visible
    if (document.visibilityState === 'visible') {
        startStatusUpdates();
    }

    // Use the Page Visibility API to stop polling when the tab is not active
    document.addEventListener('visibilitychange', function() {
        if (document.visibilityState === 'visible') {
            startStatusUpdates();
        } else {
            stopStatusUpdates();
        }
    });

    // --- GenICam Node Map Support ---
    const nodeCache = new Map();

    function applyNodeFilters(cameraId) {
        if (!nodeCache.has(cameraId)) {
            return;
        }
        const allNodes = nodeCache.get(cameraId);

        const searchInput = document.getElementById(`node-search-${cameraId}`);
        const showAllCheckbox = document.getElementById(`node-show-all-${cameraId}`);

        const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
        const showAll = showAllCheckbox ? showAllCheckbox.checked : false;

        const filteredNodes = allNodes.filter(node => {
            const hasDescription = node.description && node.description.trim() !== '';
            if (!showAll && !hasDescription) {
                return false;
            }

            if(!showAll && node.value === null){
                return false;
            }

            if(!showAll && node.access_mode === "RO"){
                return false;
            }

            if (searchTerm) {
                const searchIn = [
                    node.name,
                    node.display_name,
                    node.description
                ].join(' ').toLowerCase();
                return searchIn.includes(searchTerm);
            }

            return true;
        });

        renderNodeTable(cameraId, filteredNodes, showAll);
    }

    function renderNodeTable(cameraId, nodes, showAll) {
        const container = document.getElementById(`node-content-${cameraId}`);
        if (!container) {
            return;
        }

        container.innerHTML = ''; // Clear previous content

        if (!nodes || nodes.length === 0) {
            const emptyState = document.createElement('div');
            emptyState.className = 'p-4 text-sm text-gray-400';
            emptyState.textContent = 'No configurable nodes were reported by this camera.';
            container.appendChild(emptyState);
            return;
        }

        const table = document.createElement('table');
        table.className = 'min-w-full divide-y divide-gray-700';

        const thead = document.createElement('thead');
        thead.className = 'bg-gray-700';
        let headerHtml = `
            <tr>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-300 uppercase tracking-wider">Display Name</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-300 uppercase tracking-wider">Value</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-300 uppercase tracking-wider">Type</th>
                ${showAll ? '<th class="px-4 py-3 text-left text-xs font-semibold text-gray-300 uppercase tracking-wider">Access</th>' : ''}
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-300 uppercase tracking-wider">Update</th>
            </tr>
        `;
        thead.innerHTML = headerHtml;
        table.appendChild(thead);

        const tbody = document.createElement('tbody');
        tbody.className = 'bg-gray-800 divide-y divide-gray-700';
        table.appendChild(tbody);
        container.appendChild(table);

        nodes.forEach(node => {
            const row = document.createElement('tr');
            row.dataset.nodeName = node.name;

            const nameCell = document.createElement('td');
            nameCell.className = 'px-4 py-3 align-top';
            const title = document.createElement('div');
            title.className = 'text-sm font-medium text-white';
            title.textContent = node.display_name || node.name;
            nameCell.appendChild(title);

            const nameSubtitle = document.createElement('div');
            nameSubtitle.className = 'text-xs text-gray-400 break-all';
            nameSubtitle.textContent = node.name;
            nameCell.appendChild(nameSubtitle);

            if (node.description) {
                const description = document.createElement('div');
                description.className = 'text-xs text-gray-500 mt-1';
                description.textContent = node.description;
                nameCell.appendChild(description);
            }
            row.appendChild(nameCell);

            const valueCell = document.createElement('td');
            valueCell.className = 'px-4 py-3 text-sm text-gray-200 align-top';
            if (node.is_readable && node.value !== null && node.value !== undefined && node.value !== '') {
                valueCell.textContent = node.value;
            } else if (node.is_readable) {
                valueCell.textContent = 'Unavailable';
                valueCell.classList.add('text-gray-400');
            } else if (node.is_writable) {
                valueCell.textContent = 'Write only';
                valueCell.classList.add('text-gray-400');
            } else {
                valueCell.textContent = 'Not accessible';
                valueCell.classList.add('text-gray-500');
            }
            row.appendChild(valueCell);

            const typeCell = document.createElement('td');
            typeCell.className = 'px-4 py-3 text-sm text-gray-300 align-top';
            typeCell.textContent = node.interface_type;
            row.appendChild(typeCell);

            if (showAll) {
                const accessCell = document.createElement('td');
                accessCell.className = 'px-4 py-3 text-sm text-gray-300 align-top';
                accessCell.textContent = node.access_mode;
                row.appendChild(accessCell);
            }

            const actionCell = document.createElement('td');
            actionCell.className = 'px-4 py-3 text-sm text-gray-200 align-top';

            if (node.is_writable) {
                const form = document.createElement('form');
                form.className = 'node-update-form flex flex-col sm:flex-row sm:items-center sm:space-x-2 space-y-2 sm:space-y-0';
                form.dataset.cameraId = String(cameraId);
                form.dataset.nodeName = node.name;

                const inputWrapper = document.createElement('div');
                inputWrapper.className = 'flex-1';

                let inputElement;
                if (node.interface_type === 'boolean') {
                    inputElement = document.createElement('select');
                    inputElement.className = 'node-value-input custom-select';
                    ['True', 'False'].forEach(optionValue => {
                        const option = document.createElement('option');
                        option.value = optionValue;
                        option.textContent = optionValue;
                        inputElement.appendChild(option);
                    });
                    const normalizedValue = (node.value || '').toString().toLowerCase();
                    if (['false', '0', 'no', 'off'].includes(normalizedValue)) {
                        inputElement.value = 'False';
                    } else {
                        inputElement.value = 'True';
                    }
                } else if (node.interface_type === 'enumeration' && Array.isArray(node.choices) && node.choices.length > 0) {
                    inputElement = document.createElement('select');
                    inputElement.className = 'node-value-input custom-select';
                    if (node.value && !node.choices.includes(node.value)) {
                        const currentOption = document.createElement('option');
                        currentOption.value = node.value;
                        currentOption.textContent = node.value;
                        inputElement.appendChild(currentOption);
                    }
                    node.choices.forEach(choice => {
                        const option = document.createElement('option');
                        option.value = choice;
                        option.textContent = choice;
                        inputElement.appendChild(option);
                    });
                    if (node.value) {
                        inputElement.value = node.value;
                    }
                } else {
                    inputElement = document.createElement('input');
                    inputElement.type = (node.interface_type === 'integer' || node.interface_type === 'float') ? 'number' : 'text';
                    if (node.interface_type === 'float') {
                        inputElement.step = 'any';
                    }
                    inputElement.className = 'node-value-input custom-select';
                    if (node.value !== null && node.value !== undefined) {
                        inputElement.value = node.value;
                    } else {
                        inputElement.placeholder = 'Enter value';
                    }
                }

                inputElement.name = 'node-value';
                inputWrapper.appendChild(inputElement);
                form.appendChild(inputWrapper);

                const button = document.createElement('button');
                button.type = 'submit';
                button.className = 'inline-flex justify-center px-3 py-1.5 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500';
                button.textContent = 'Update';
                form.appendChild(button);

                actionCell.appendChild(form);

                const feedback = document.createElement('div');
                feedback.className = 'text-xs mt-2 hidden';
                feedback.dataset.nodeFeedback = 'true';
                actionCell.appendChild(feedback);
            } else {
                actionCell.classList.add('text-gray-500');
                actionCell.textContent = 'Read-only';
            }

            row.appendChild(actionCell);
            tbody.appendChild(row);
        });
    }

    function loadNodesForCamera(cameraId, options = {}) {
        const { force = false } = options;
        const container = document.getElementById(`node-content-${cameraId}`);
        if (!container) {
            return;
        }

        if (force) {
            nodeCache.delete(cameraId);
        }

        if (!force && nodeCache.has(cameraId)) {
            applyNodeFilters(cameraId);
            return;
        }

        container.innerHTML = '<div class="p-4 text-sm text-gray-400">Loading node map...</div>';

        fetch(`/cameras/genicam/nodes/${cameraId}`)
            .then(async response => {
                let payload;
                try {
                    payload = await response.json();
                } catch (error) {
                    payload = { error: 'Invalid server response.' };
                }

                if (!response.ok) {
                    const message = payload && payload.error ? payload.error : `Request failed (${response.status})`;
                    throw new Error(message);
                }

                return payload;
            })
            .then(data => {
                const nodes = Array.isArray(data.nodes) ? data.nodes : [];
                nodeCache.set(cameraId, nodes);
                applyNodeFilters(cameraId);
            })
            .catch(error => {
                const errorContainer = document.createElement('div');
                errorContainer.className = 'p-4 text-sm text-red-400';
                errorContainer.textContent = error.message || 'Failed to load node map.';
                container.innerHTML = '';
                container.appendChild(errorContainer);
            });
    }

    window.toggleNodeDetails = function(cameraId) {
        const row = document.getElementById(`node-row-${cameraId}`);
        if (!row) {
            return;
        }

        const isHidden = row.classList.contains('hidden');
        if (isHidden) {
            row.classList.remove('hidden');
            loadNodesForCamera(cameraId);

            // Add event listeners if they haven't been added yet
            const searchInput = document.getElementById(`node-search-${cameraId}`);
            const showAllCheckbox = document.getElementById(`node-show-all-${cameraId}`);

            if (searchInput && !searchInput.dataset.listenerAttached) {
                searchInput.addEventListener('input', () => applyNodeFilters(cameraId));
                searchInput.dataset.listenerAttached = 'true';
            }

            if (showAllCheckbox && !showAllCheckbox.dataset.listenerAttached) {
                showAllCheckbox.addEventListener('change', () => applyNodeFilters(cameraId));
                showAllCheckbox.dataset.listenerAttached = 'true';
            }
        } else {
            row.classList.add('hidden');
        }
    };

    window.refreshNodeMap = function(cameraId) {
        loadNodesForCamera(cameraId, { force: true });
    };

    document.addEventListener('submit', function(event) {
        if (!event.target.classList.contains('node-update-form')) {
            return;
        }

        event.preventDefault();

        const form = event.target;
        const cameraId = form.dataset.cameraId;
        const nodeName = form.dataset.nodeName;
        const input = form.querySelector('.node-value-input');
        const value = input ? input.value : '';

        updateNodeValue(cameraId, nodeName, value, form);
    });

    function updateNodeValue(cameraId, nodeName, value, form) {
        if (!cameraId || !nodeName) {
            return;
        }

        const submitButton = form.querySelector('button[type="submit"]');
        const feedback = form.parentElement.querySelector('[data-node-feedback="true"]');

        if (feedback) {
            feedback.textContent = '';
            feedback.classList.add('hidden');
            feedback.classList.remove('text-red-400', 'text-green-400');
        }

        if (submitButton) {
            submitButton.disabled = true;
            submitButton.dataset.originalText = submitButton.textContent;
            submitButton.textContent = 'Saving...';
        }

        fetch(`/cameras/genicam/nodes/${cameraId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ name: nodeName, value: value })
        })
            .then(async response => {
                let payload;
                try {
                    payload = await response.json();
                } catch (error) {
                    payload = { error: 'Invalid server response.' };
                }

                if (!response.ok) {
                    const message = payload && payload.error ? payload.error : `Request failed (${response.status})`;
                    throw new Error(message);
                }

                return payload;
            })
            .then(data => {
                if (feedback) {
                    feedback.textContent = data.message || 'Node updated successfully.';
                    feedback.classList.remove('hidden');
                    feedback.classList.remove('text-red-400');
                    feedback.classList.add('text-green-400');
                     setTimeout(() => {
                        feedback.classList.add('hidden');
                    }, 3000);
                }

                // --- In-place Update Logic ---
                const updatedNode = data.node;
                if (!updatedNode) {
                    // Fallback to full refresh if the server doesn't return the node
                    loadNodesForCamera(cameraId, { force: true });
                    return;
                }

                // 1. Update cache
                if (nodeCache.has(cameraId)) {
                    const nodes = nodeCache.get(cameraId);
                    const nodeIndex = nodes.findIndex(n => n.name === nodeName);
                    if (nodeIndex !== -1) {
                        nodes[nodeIndex] = { ...nodes[nodeIndex], ...updatedNode };
                    }
                }

                // 2. Update DOM
                const container = document.getElementById(`node-content-${cameraId}`);
                const row = container.querySelector(`tr[data-node-name="${nodeName}"]`);
                if (row) {
                    const valueCell = row.cells[1];
                    if (valueCell) {
                        valueCell.textContent = updatedNode.value;
                    }

                    // Optional: Highlight the row briefly
                    row.classList.add('bg-indigo-900', 'transition-colors', 'duration-500');
                    setTimeout(() => {
                        row.classList.remove('bg-indigo-900');
                    }, 1000);
                }
            })
            .catch(error => {
                if (feedback) {
                    feedback.textContent = error.message || 'Failed to update node.';
                    feedback.classList.remove('hidden');
                    feedback.classList.remove('text-green-400');
                    feedback.classList.add('text-red-400');
                }
            })
            .finally(() => {
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.textContent = submitButton.dataset.originalText || 'Update';
                }
            });
    }

    // --- Modal and Form Logic ---
    const modal = document.getElementById('camera-form-modal');
    const modalTitle = document.getElementById('modal-title');
    const cameraForm = document.getElementById('camera-form');
    const cameraNameInput = document.getElementById('camera-name-modal');
    const addCameraFields = document.getElementById('add-camera-fields');
    
    const cameraTypeSelect = document.getElementById('camera-type-modal');
    const usbSection = document.getElementById('usb-camera-section-modal');
    const genicamSection = document.getElementById('genicam-camera-section-modal');
    const oakdSection = document.getElementById('oakd-camera-section-modal');
    const usbSelect = document.getElementById('usb-camera-select-modal');
    const genicamSelect = document.getElementById('genicam-camera-select-modal');
    const oakdSelect = document.getElementById('oakd-camera-select-modal');
    const saveButton = document.getElementById('save-camera-button');

    function validateModalForm() {
        if (!modal || !cameraNameInput || !saveButton) return;

        const isAddMode = !addCameraFields.classList.contains('hidden');
        const isNameValid = cameraNameInput.value.trim() !== '';

        if (!isAddMode) {
            saveButton.disabled = !isNameValid;
            return;
        }

        const cameraType = cameraTypeSelect.value;
        const isTypeSelected = !!cameraType;

        let isCameraSelected = false;
        if (cameraType === 'USB') {
            isCameraSelected = !!usbSelect.value;
        } else if (cameraType === 'GenICam') {
            isCameraSelected = !!genicamSelect.value;
        } else if (cameraType === 'OAK-D') {
            isCameraSelected = !!oakdSelect.value;
        }

        saveButton.disabled = !(isNameValid && isTypeSelected && isCameraSelected);
    }

    // Attach event listeners to all relevant inputs
    cameraNameInput.addEventListener('input', validateModalForm);
    cameraTypeSelect.addEventListener('change', validateModalForm);
    usbSelect.addEventListener('change', validateModalForm);
    genicamSelect.addEventListener('change', validateModalForm);
    oakdSelect.addEventListener('change', validateModalForm);

    // --- Modal Control ---
    window.openAddModal = function() {
        modalTitle.textContent = 'Add New Camera';
        cameraForm.action = "{{ url_for('cameras.add_camera') }}";
        cameraNameInput.value = '';
        
        addCameraFields.classList.remove('hidden');
        cameraTypeSelect.required = true;
        
        // Reset and hide dynamic sections
        cameraTypeSelect.value = '';
        usbSection.classList.add('hidden');
        genicamSection.classList.add('hidden');
        usbSelect.disabled = true;
        genicamSelect.disabled = true;

        // Auto-select if only one camera type is available
        const visibleOptions = Array.from(cameraTypeSelect.options).filter(opt => opt.style.display !== 'none' && opt.value !== '');
        if (visibleOptions.length === 1) {
            cameraTypeSelect.value = visibleOptions[0].value;
            // Trigger the change event to auto-load camera list
            cameraTypeSelect.dispatchEvent(new Event('change'));
        }

        modal.classList.remove('hidden');
        validateModalForm(); // Set initial button state
    }

    window.openEditModal = function(cameraId, cameraName) {
        // Note: The onclick in the table still calls this function directly
        modalTitle.textContent = 'Edit Camera';
        cameraForm.action = `/cameras/update/${cameraId}`;
        cameraNameInput.value = cameraName;
        
        addCameraFields.classList.add('hidden');
        cameraTypeSelect.required = false;

        modal.classList.remove('hidden');
        validateModalForm(); // Set initial button state
    }

    window.closeModal = function() {
        modal.classList.add('hidden');
    }

    // --- Dynamic Camera Discovery for Add Modal ---
    cameraTypeSelect.addEventListener('change', function() {
        const selectedType = this.value;

        usbSection.classList.add('hidden');
        genicamSection.classList.add('hidden');
        oakdSection.classList.add('hidden');
        usbSelect.disabled = true;
        genicamSelect.disabled = true;
        oakdSelect.disabled = true;

        if (!selectedType) {
            validateModalForm();
            return;
        }
        
        const existingIdentifiers = new Set();
        document.querySelectorAll('tr[data-camera-id]').forEach(row => {
            const identifier = row.cells[2].textContent.trim();
            existingIdentifiers.add(identifier);
        });
        const url = `/cameras/discover?existing=${Array.from(existingIdentifiers).join(',')}`;
        
        // Show a loading state in the relevant select
        let targetSelect, targetSection;
        if (selectedType === 'USB') {
            targetSelect = usbSelect;
            targetSection = usbSection;
        } else if (selectedType === 'GenICam') {
            targetSelect = genicamSelect;
            targetSection = genicamSection;
        } else if (selectedType === 'OAK-D') {
            targetSelect = oakdSelect;
            targetSection = oakdSection;
        }

        if (targetSelect && targetSection) {
            targetSection.classList.remove('hidden');
            targetSelect.disabled = true;
            targetSelect.innerHTML = '<option>Loading...</option>';
            validateModalForm();
        }

        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (selectedType === 'USB') {
                    populateSelect(usbSelect, data.usb);
                    usbSelect.disabled = false;
                } else if (selectedType === 'GenICam') {
                    populateSelect(genicamSelect, data.genicam);
                    genicamSelect.disabled = false;
                } else if (selectedType === 'OAK-D') {
                    populateSelect(oakdSelect, data.oakd);
                    oakdSelect.disabled = false;
                }
                // Re-validate after populating and enabling the select
                validateModalForm();
            })
            .catch(error => {
                console.error('Error discovering cameras:', error);
                targetSelect.innerHTML = '<option>Error loading cameras</option>';
                validateModalForm();
            });
    });

    function populateSelect(selectElement, items) {
        selectElement.innerHTML = '';
        if (items && items.length > 0) {
            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item.identifier;
                option.textContent = item.name;
                selectElement.appendChild(option);
            });
            // Auto-select the first camera if it's the only one
            if (items.length === 1) {
                selectElement.value = items[0].identifier;
            }
        } else {
            const option = document.createElement('option');
            option.value = '';
            option.textContent = 'No available cameras found';
            option.disabled = true;
            selectElement.appendChild(option);
        }
    }
});
</script>
{% endblock %}