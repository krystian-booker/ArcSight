{% extends "layouts/base.html" %}
{% block title %}Settings{% endblock %}
{% block content %}
<div x-data="settingsApp({
        selectedField: {{ selected_field|tojson }},
        defaultFields: {{ default_fields|map(attribute='name')|list|tojson }},
        userFields: {{ user_fields|map(attribute='name')|list|tojson }},
        endpoints: {
            select: '{{ url_for("settings.select_apriltag_field") }}',
            upload: '{{ url_for("settings.upload_apriltag_field") }}',
            delete: '{{ url_for("settings.delete_apriltag_field") }}'
        }
    })" x-cloak class="stack stack-2xl">
    <header class="stack stack-sm">
        <h1>Settings</h1>
        <p class="muted text-small">Configure network identity, GenICam integration, and device-level controls for
            ArcSight deployments.</p>
    </header>

    <section class="panel stack stack-lg">
        <h2 class="panel-title">Global Settings</h2>
        <form action="{{ url_for('settings.update_global_settings') }}" method="POST" class="stack stack-lg">
            <div class="grid-2 grid-tight">
                <div class="form-field">
                    <label class="form-label" for="team-number">Team Number</label>
                    <input type="number" name="team_number" id="team-number" value="{{ settings.team_number or '' }}"
                        class="form-control">
                </div>
                <div class="form-field">
                    <label class="form-label" for="hostname">Hostname</label>
                    <input type="text" name="hostname" id="hostname" value="{{ current_hostname }}"
                        class="form-control">
                </div>
            </div>

            <fieldset class="stack stack-sm">
                <legend class="form-label">IP Assignment Mode</legend>
                <div class="cluster cluster-wrap">
                    <label class="cluster text-small">
                        <input type="radio" name="ip_mode" value="DHCP" class="form-checkbox" {% if
                            current_network_settings.ip_mode=='DHCP' %}checked{% endif %}>
                        <span>DHCP</span>
                    </label>
                    <label class="cluster text-small">
                        <input type="radio" name="ip_mode" value="Static" class="form-checkbox" {% if
                            current_network_settings.ip_mode=='Static' %}checked{% endif %}>
                        <span>Static</span>
                    </label>
                </div>
            </fieldset>

            <div class="cluster justify-end">
                <button type="submit" class="button button--primary">
                    Save Global Settings
                </button>
            </div>
        </form>
    </section>

    <section class="panel stack stack-lg">
        <h2 class="panel-title">GenICam Settings</h2>
        <form action="{{ url_for('settings.update_genicam_settings') }}" method="POST" class="stack stack-lg">
            <div class="form-field">
                <label class="form-label" for="genicam-cti-path">GenTL Producer Path (.cti file)</label>
                <span class="muted text-small">Current: {{ settings.genicam_cti_path or 'Not set' }}</span>
                <input type="text" id="genicam-cti-path" name="genicam-cti-path"
                    placeholder="C:\\path\\to\\your\\genicam.cti" class="form-control">
                <p class="form-hint">Enter the full path to the .cti file from your camera SDK. ArcSight requires this
                    to communicate with GenICam hardware.</p>
            </div>
            <div class="cluster justify-end">
                <button type="submit" class="button button--primary">
                    Save GenICam Settings
                </button>
            </div>
        </form>
    </section>

    <section class="panel stack stack-lg">
        <h2 class="panel-title">AprilTag Field Layout</h2>
        <div class="stack stack-lg">
            <form class="stack stack-sm" @submit.prevent="saveApriltagFieldSelection">
                <div class="form-field">
                    <label class="form-label" for="apriltag-field-select">Selected Field</label>
                    <select id="apriltag-field-select" class="form-control" x-model="apriltag.selectedField">
                        <option value="">No field selected</option>
                        <template x-if="apriltag.defaultFields.length">
                            <optgroup label="Defaults">
                                <template x-for="name in apriltag.defaultFields" :key="`default-${name}`">
                                    <option :value="name" x-text="name"></option>
                                </template>
                            </optgroup>
                        </template>
                        <template x-if="apriltag.userFields.length">
                            <optgroup label="Your Uploads">
                                <template x-for="name in apriltag.userFields" :key="`user-${name}`">
                                    <option :value="name" x-text="name"></option>
                                </template>
                            </optgroup>
                        </template>
                    </select>
                    <p class="form-hint text-small">
                        Selection applies to all AprilTag pipelines. Restart ArcSight or camera pipelines to pick up
                        changes.
                    </p>
                </div>
                <div class="cluster justify-end">
                    <button type="submit" class="button button--primary" :disabled="apriltag.savingSelection">
                        <span x-show="!apriltag.savingSelection">Save Field Selection</span>
                        <span x-show="apriltag.savingSelection">Saving...</span>
                    </button>
                </div>
            </form>

            <form class="stack stack-sm" @submit.prevent="uploadApriltagField" x-ref="apriltagUploadForm">
                <div class="form-field">
                    <label class="form-label" for="apriltag-field-upload">Upload Field Layout (.json)</label>
                    <input type="file" id="apriltag-field-upload" class="form-control" accept=".json,application/json"
                        x-ref="apriltagUploadInput">
                    <p class="form-hint text-small">
                        Upload a WPILib AprilTag field layout JSON. Files larger than 1&nbsp;MB are rejected.
                    </p>
                </div>
                <div class="cluster justify-end">
                    <button type="submit" class="button" :disabled="apriltag.uploading">
                        <span x-show="!apriltag.uploading">Upload Layout</span>
                        <span x-show="apriltag.uploading">Uploading...</span>
                    </button>
                </div>
            </form>

            <div class="stack stack-sm">
                <header class="stack stack-2xs">
                    <h3 class="text-small">Your Uploads</h3>
                    <p class="muted text-xsmall">Custom layouts live in your VisionTools data directory.</p>
                </header>
                <template x-if="!apriltag.userFields.length">
                    <p class="muted text-small">No user layouts uploaded yet.</p>
                </template>
                <template x-for="name in apriltag.userFields" :key="`user-list-${name}`">
                    <div class="surface surface--subtle cluster justify-between align-center">
                        <span class="text-small" x-text="name"></span>
                        <button type="button" class="button button--danger button--ghost text-small"
                            @click="deleteApriltagField(name)" :disabled="apriltag.deleting === name">
                            <span x-show="apriltag.deleting !== name">Delete</span>
                            <span x-show="apriltag.deleting === name">Removing...</span>
                        </button>
                    </div>
                </template>
            </div>
        </div>
    </section>

    <section class="panel stack stack-lg">
        <h2 class="panel-title">Device Control</h2>
        <div class="grid-2 grid-tight">
            <button type="button" class="button button--primary"
                @click="submitPost('{{ url_for('settings.restart_app') }}')">
                Restart ArcSight
            </button>
            <button type="button" class="button button--primary"
                @click="submitPost('{{ url_for('settings.reboot_device') }}')">
                Restart Device
            </button>
            <a href="{{ url_for('settings.export_db') }}" class="button">
                Export Configuration
            </a>
            <button type="button" class="button" @click="triggerImport">
                Import Configuration
            </button>
        </div>
        <button type="button" class="button button--danger w-100" @click="openFactoryResetModal">
            Factory Reset
        </button>
        <form id="import-db-form" action="{{ url_for('settings.import_db') }}" method="POST"
            enctype="multipart/form-data" hidden>
            <input type="file" name="database" id="import-db-input" x-ref="importInput" @change="handleImportChange">
        </form>
    </section>

    <div class="modal-overlay" id="factoryResetModal" x-show="factoryResetOpen" x-transition>
        <div class="modal-content stack stack-lg">
            <header class="stack stack-xs">
                <h3>Confirm Factory Reset</h3>
                <p class="panel-hint">Factory reset deletes all cameras, settings, and cached data.</p>
            </header>
            <p>Are you sure you want to factory reset? This action cannot be undone.</p>
            <div class="cluster justify-end">
                <button type="button" class="button button--ghost" @click="closeFactoryResetModal">
                    Cancel
                </button>
                <button type="button" class="button button--danger"
                    @click="confirmFactoryReset('{{ url_for('settings.factory_reset') }}')">
                    Factory Reset
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}