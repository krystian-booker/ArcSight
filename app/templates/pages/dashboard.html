{% extends "layouts/base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<div
    x-data="dashboardApp({ cameras: {{ cameras|tojson|safe }} })"
    x-cloak
    class="stack stack-2xl"
>
    <header class="stack stack-lg">
        <div class="stack stack-sm">
            <h1>Dashboard</h1>
        </div>
        <div class="info-bar cluster cluster-wrap">
            <span>Registered cameras: <strong x-text="cameras.length"></strong></span>
            <span>Pipelines: <strong x-text="pipelines.length"></strong></span>
            <span>Feed selector: <strong x-text="feedType === 'processed' ? 'Processed' : 'Default'"></strong></span>
        </div>
    </header>

    <section class="grid-3 grid-loose align-start">
        <article class="panel stack stack-lg">
            <header class="stack stack-sm">
                <h2 class="panel-title">Pipeline Control</h2>
                <p class="panel-hint">Select a camera, attach a pipeline, and decide how ArcSight should process frames.</p>
            </header>

            <div class="form-field">
                <label for="camera-select" class="form-label">Select Camera</label>
                <select
                    id="camera-select"
                    class="form-control"
                    x-model="selectedCameraId"
                >
                    {% if cameras %}
                    <option value="">Select a camera…</option>
                    {% else %}
                    <option value="" disabled>No cameras configured</option>
                    {% endif %}
                    <template x-for="camera in cameras" :key="camera.id">
                        <option :value="String(camera.id)" x-text="camera.name"></option>
                    </template>
                </select>
            </div>

            <div class="form-field">
                <label class="form-label">Pipeline</label>
                <div class="cluster cluster-wrap">
                    <select
                        class="form-control form-control--inline"
                        :disabled="!pipelines.length"
                        x-model="selectedPipelineId"
                    >
                        <option value="" :disabled="!pipelines.length">Select a pipeline…</option>
                        <template x-for="pipeline in pipelines" :key="pipeline.id">
                            <option :value="pipeline.id" x-text="pipeline.name"></option>
                        </template>
                    </select>
                    <button class="button-icon" type="button" :disabled="!hasCamera" @click="addPipeline">
                        <span class="sr-only">Add pipeline</span>
                        <svg viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M10 4a1 1 0 0 1 1 1v4h4a1 1 0 0 1 0 2h-4v4a1 1 0 0 1-2 0v-4H5a1 1 0 1 1 0-2h4V5a1 1 0 0 1 1-1Z" clip-rule="evenodd"/></svg>
                    </button>
                    <button class="button-icon" type="button" :disabled="!selectedPipelineId" @click="renamePipeline">
                        <span class="sr-only">Rename pipeline</span>
                        <svg viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path d="M13.586 3.586a2 2 0 1 1 2.828 2.828l-.793.793-2.828-2.828.793-.793Zm-2.207 2.207L4 13.172V16h2.828l7.379-7.379-2.828-2.828Z"/></svg>
                    </button>
                    <button class="button-icon" type="button" :disabled="!selectedPipelineId" @click="deletePipeline">
                        <span class="sr-only">Delete pipeline</span>
                        <svg viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M8 2a1 1 0 0 0-.894.553L6.382 4H4a1 1 0 1 0 0 2v10a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V6a1 1 0 1 0 0-2h-2.382l-.724-1.447A1 1 0 0 0 12 2H8Zm2 6a1 1 0 0 1 1 1v6a1 1 0 1 1-2 0V9a1 1 0 0 1 1-1Zm-3 1a1 1 0 0 1 2 0v6a1 1 0 1 1-2 0V9Zm6 0a1 1 0 1 1 2 0v6a1 1 0 1 1-2 0V9Z" clip-rule="evenodd"/></svg>
                    </button>
                </div>
                <p class="form-hint" x-show="!pipelines.length">Create a pipeline to enable processed feeds.</p>
            </div>

            <div class="form-field">
                <label for="pipeline-type" class="form-label">Pipeline Type</label>
                <select
                    id="pipeline-type"
                    class="form-control"
                    :disabled="!selectedPipelineId"
                    x-model="pipelineType"
                    @change="onPipelineTypeChange($event.target.value)"
                >
                    <option value="AprilTag">AprilTag</option>
                    <option value="Coloured Shape">Coloured Shape</option>
                    <option value="Object Detection (ML)">Object Detection (ML)</option>
                </select>
            </div>
        </article>

        <article class="panel stack stack-lg">
            <header class="stack stack-sm">
                <h2 class="panel-title">Camera Input</h2>
                <p class="panel-hint">Establish the best feed quality for detection by tuning orientation, exposure, and gain.</p>
            </header>

            <div class="form-field">
                <label for="orientation" class="form-label">Orientation</label>
                <select
                    id="orientation"
                    class="form-control"
                    x-model.number="controls.orientation"
                    @change="queueControlsSave"
                    :disabled="!hasCamera"
                >
                    <option :value="0">Normal (0°)</option>
                    <option :value="90">Rotate 90°</option>
                    <option :value="180">Rotate 180°</option>
                    <option :value="270">Rotate 270°</option>
                </select>
            </div>

            <div class="form-field">
                <label class="form-label">Exposure</label>
                <div class="stack stack-sm">
                    <select
                        class="form-control"
                        x-model="controls.exposure_mode"
                        :disabled="!hasCamera"
                        @change="onExposureModeChange($event.target.value)"
                    >
                        <option value="auto">Auto</option>
                        <option value="manual">Manual</option>
                    </select>
                    <div class="cluster">
                        <input
                            type="range"
                            min="0"
                            max="1000"
                            class="form-range"
                            x-model.number="controls.exposure_value"
                            :disabled="!exposureManual"
                            @input.debounce.300="queueControlsSave"
                        >
                        <input
                            type="number"
                            min="0"
                            max="1000"
                            class="form-control form-control--small"
                            x-model.number="controls.exposure_value"
                            :disabled="!exposureManual"
                            @change.debounce.300="queueControlsSave"
                        >
                    </div>
                </div>
            </div>

            <div class="form-field">
                <label class="form-label">Gain</label>
                <div class="stack stack-sm">
                    <select
                        class="form-control"
                        x-model="controls.gain_mode"
                        :disabled="!hasCamera"
                        @change="onGainModeChange($event.target.value)"
                    >
                        <option value="auto">Auto</option>
                        <option value="manual">Manual</option>
                    </select>
                    <div class="cluster">
                        <input
                            type="range"
                            min="0"
                            max="100"
                            class="form-range"
                            x-model.number="controls.gain_value"
                            :disabled="!gainManual"
                            @input.debounce.300="queueControlsSave"
                        >
                        <input
                            type="number"
                            min="0"
                            max="100"
                            class="form-control form-control--small"
                            x-model.number="controls.gain_value"
                            :disabled="!gainManual"
                            @change.debounce.300="queueControlsSave"
                        >
                    </div>
                </div>
            </div>
        </article>

        <article class="panel stack stack-lg">
            <header class="stack stack-sm">
                <h2 class="panel-title">Live Feed</h2>
                <p class="panel-hint">Inspect the incoming stream or switch to the processed output for verification.</p>
            </header>

            <div class="video-feed-wrapper">
                <template x-if="isCameraConnected && feedSrc">
                    <img :src="feedSrc" alt="Camera Feed" class="w-100">
                </template>
                <template x-if="!hasCamera">
                    <div class="stack stack-sm muted text-center" style="padding: var(--space-xl);">
                        <span>Select a camera to view its feed.</span>
                    </div>
                </template>
                <template x-if="hasCamera && !isCameraConnected">
                    <div class="stack stack-sm callout callout-danger text-center">
                        <span>Camera is not connected.</span>
                    </div>
                </template>
                <template x-if="hasCamera && isCameraConnected && !feedSrc">
                    <div class="stack stack-sm muted text-center" style="padding: var(--space-xl);" x-text="feedError || 'Loading feed…'"></div>
                </template>
            </div>

            <div class="cluster cluster-wrap">
                <label class="cluster muted text-small">
                    <input type="radio" value="default" x-model="feedType" :disabled="!hasCamera">
                    <span>Default feed</span>
                </label>
                <label class="cluster muted text-small">
                    <input type="radio" value="processed" x-model="feedType" :disabled="!canUseProcessedFeed">
                    <span>Processed feed</span>
                </label>
            </div>
            <p class="callout callout-danger text-small" x-show="feedError" x-text="feedError"></p>
        </article>
    </section>

    <section class="panel stack stack-xl">
        <header class="cluster cluster-wrap justify-between align-start">
            <div class="stack stack-xs">
                <h2 class="panel-title">Pipeline Settings</h2>
                <p class="panel-hint">Adjust parameters for the selected pipeline. Changes apply live while the feed runs.</p>
            </div>
            <div class="status-pill" :class="{ 'status-pill--ok': !!pipeline, 'status-pill--warn': !pipeline }">
                <span class="status-pill__dot"></span>
                <span x-text="pipeline ? pipeline.name : 'No pipeline selected'"></span>
            </div>
        </header>
        <div class="stack stack-xl">
            {% include 'partials/dashboard/_apriltag_form.html' %}
            {% include 'partials/dashboard/_coloured_shape_form.html' %}
            {% include 'partials/dashboard/_ml_form.html' %}
        </div>
    </section>

    <div
        class="modal-overlay"
        x-show="pipelineModal.open"
        x-transition
        x-cloak
    >
        <div class="modal-content stack stack-lg">
            <header class="stack stack-xs">
                <h3>Pipeline</h3>
                <p class="panel-hint" x-text="pipelineModal.mode === 'add' ? 'Define a fresh pipeline for the selected camera.' : 'Update the current pipeline.'"></p>
            </header>
            <div class="stack stack-md">
                <div class="form-field">
                    <label class="form-label" for="pipeline-name">Name</label>
                    <input
                        id="pipeline-name"
                        type="text"
                        class="form-control"
                        x-model="pipelineModal.name"
                        placeholder="Enter pipeline name"
                    >
                </div>
                <div class="form-field">
                    <label class="form-label" for="pipeline-modal-type">Type</label>
                    <select
                        id="pipeline-modal-type"
                        class="form-control"
                        x-model="pipelineModal.type"
                    >
                        <template x-for="type in pipelineTypes" :key="type">
                            <option :value="type" x-text="type"></option>
                        </template>
                    </select>
                    <p class="form-hint" x-show="pipelineModal.mode === 'edit'">
                        Changing the pipeline type will reset its configuration.
                    </p>
                </div>
            </div>
            <div class="cluster justify-end">
                <button
                    type="button"
                    class="button button--ghost"
                    @click="closePipelineModal"
                    :disabled="pipelineModal.saving"
                >
                    Cancel
                </button>
                <button
                    type="button"
                    class="button button--primary"
                    @click="submitPipelineModal"
                    :disabled="pipelineModal.saving"
                >
                    <span x-show="!pipelineModal.saving">Save</span>
                    <span x-show="pipelineModal.saving">Saving…</span>
                </button>
            </div>
        </div>
    </div>

    <div
        class="modal-overlay"
        x-show="deleteModal.open"
        x-transition
        x-cloak
    >
        <div class="modal-content stack stack-lg">
            <header class="stack stack-xs">
                <h3>Delete Pipeline</h3>
                <p class="panel-hint">Confirm removal to free the slot for another configuration.</p>
            </header>
            <p>Are you sure you want to remove <strong x-text="deleteModal.name"></strong>? This cannot be undone.</p>
            <div class="cluster justify-end">
                <button
                    type="button"
                    class="button button--ghost"
                    @click="closeDeleteModal"
                    :disabled="deleteModal.saving"
                >
                    Cancel
                </button>
                <button
                    type="button"
                    class="button button--danger"
                    @click="confirmDeletePipeline"
                    :disabled="deleteModal.saving"
                >
                    <span x-show="!deleteModal.saving">Delete</span>
                    <span x-show="deleteModal.saving">Deleting…</span>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
