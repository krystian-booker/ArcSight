{% extends "layouts/base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<div
    x-data="dashboardApp({ cameras: {{ cameras|tojson|safe }} })"
    x-cloak
    class="space-y-6"
>
    <h1 class="text-3xl font-bold">Dashboard</h1>

    <div class="flex flex-wrap md:flex-nowrap gap-4">
        <div class="w-full md:w-1/3">
            <div class="bg-gray-800 rounded-lg p-4 h-full">
                <h2 class="text-xl font-bold mb-4">Configuration</h2>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-300 mb-2">Select Camera</label>
                    <select
                        class="custom-select w-full"
                        x-model="selectedCameraId"
                    >
                        {% if not cameras %}
                        <option value="">No cameras configured</option>
                        {% endif %}
                        <template x-for="camera in cameras" :key="camera.id">
                            <option :value="String(camera.id)" x-text="camera.name"></option>
                        </template>
                    </select>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-300 mb-2">Pipeline</label>
                    <div class="flex items-center gap-2">
                        <select
                            class="custom-select w-full"
                            :disabled="!pipelines.length"
                            x-model="selectedPipelineId"
                        >
                            <option value="" x-show="!pipelines.length">No pipelines configured</option>
                            <template x-for="pipeline in pipelines" :key="pipeline.id">
                                <option :value="pipeline.id" x-text="pipeline.name"></option>
                            </template>
                        </select>
                        <button class="btn btn-primary" type="button" :disabled="!hasCamera" @click="addPipeline">
                            <span class="sr-only">Add pipeline</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <button class="btn btn-secondary" type="button" :disabled="!selectedPipelineId" @click="renamePipeline">
                            <span class="sr-only">Rename pipeline</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                            </svg>
                        </button>
                        <button class="btn btn-danger" type="button" :disabled="!selectedPipelineId" @click="deletePipeline">
                            <span class="sr-only">Delete pipeline</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                    <p class="text-xs text-gray-400 mt-2" x-show="!pipelines.length">Create a pipeline to enable processed feeds.</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Pipeline Type</label>
                    <select
                        class="custom-select w-full"
                        :disabled="!selectedPipelineId"
                        x-model="pipelineType"
                        @change="onPipelineTypeChange($event.target.value)"
                    >
                        <option value="AprilTag">AprilTag</option>
                        <option value="Coloured Shape">Coloured Shape</option>
                        <option value="Object Detection (ML)">Object Detection (ML)</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="w-full md:w-1/3">
            <div class="bg-gray-800 rounded-lg p-4 h-full">
                <h2 class="text-xl font-bold mb-4">Camera Input</h2>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-300 mb-2">Orientation</label>
                    <select
                        class="custom-select w-full"
                        x-model.number="controls.orientation"
                        @change="queueControlsSave"
                        :disabled="!hasCamera"
                    >
                        <option :value="0">Normal (0°)</option>
                        <option :value="90">Rotate 90°</option>
                        <option :value="180">Rotate 180°</option>
                        <option :value="270">Rotate 270°</option>
                    </select>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-300 mb-2">Exposure</label>
                    <select
                        class="custom-select mb-2"
                        x-model="controls.exposure_mode"
                        :disabled="!hasCamera"
                        @change="onExposureModeChange($event.target.value)"
                    >
                        <option value="auto">Auto</option>
                        <option value="manual">Manual</option>
                    </select>
                    <div class="flex items-center gap-4">
                        <input
                            type="range"
                            min="0"
                            max="1000"
                            class="w-full"
                            x-model.number="controls.exposure_value"
                            :disabled="!exposureManual"
                            @input.debounce.300="queueControlsSave"
                        >
                        <input
                            type="number"
                            min="0"
                            max="1000"
                            class="w-24 custom-select"
                            x-model.number="controls.exposure_value"
                            :disabled="!exposureManual"
                            @change.debounce.300="queueControlsSave"
                        >
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Gain</label>
                    <select
                        class="custom-select mb-2"
                        x-model="controls.gain_mode"
                        :disabled="!hasCamera"
                        @change="onGainModeChange($event.target.value)"
                    >
                        <option value="auto">Auto</option>
                        <option value="manual">Manual</option>
                    </select>
                    <div class="flex items-center gap-4">
                        <input
                            type="range"
                            min="0"
                            max="100"
                            class="w-full"
                            x-model.number="controls.gain_value"
                            :disabled="!gainManual"
                            @input.debounce.300="queueControlsSave"
                        >
                        <input
                            type="number"
                            min="0"
                            max="100"
                            class="w-24 custom-select"
                            x-model.number="controls.gain_value"
                            :disabled="!gainManual"
                            @change.debounce.300="queueControlsSave"
                        >
                    </div>
                </div>
            </div>
        </div>

        <div class="w-full md:w-1/3">
            <div class="bg-gray-800 rounded-lg p-4 h-full flex flex-col">
                <h2 class="text-xl font-bold mb-4">Feed</h2>
                <div class="flex-1 bg-black rounded flex items-center justify-center">
                    <template x-if="isCameraConnected && feedSrc">
                        <img :src="feedSrc" alt="Camera Feed" class="w-full h-full object-contain rounded">
                    </template>
                    <template x-if="!hasCamera">
                        <p class="text-gray-500 text-center px-4">Select a camera to view its feed.</p>
                    </template>
                    <template x-if="hasCamera && !isCameraConnected">
                        <p class="text-red-400 text-center px-4">Camera is not connected.</p>
                    </template>
                    <template x-if="hasCamera && isCameraConnected && !feedSrc">
                        <p class="text-gray-400 text-center px-4" x-text="feedError || 'Loading feed…'"></p>
                    </template>
                </div>
                <div class="mt-4 text-center space-x-6">
                    <label class="inline-flex items-center">
                        <input type="radio" value="default" x-model="feedType" :disabled="!hasCamera">
                        <span class="ml-2">Default Feed</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" value="processed" x-model="feedType" :disabled="!canUseProcessedFeed">
                        <span class="ml-2">Processed Feed</span>
                    </label>
                </div>
                <p class="text-sm text-red-400 text-center mt-2" x-show="feedError" x-text="feedError"></p>
            </div>
        </div>
    </div>

    <div class="bg-gray-800 rounded-lg p-4">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-bold">Pipeline Settings</h2>
            <div class="text-sm text-gray-400">
                <span x-text="pipeline ? pipeline.name : 'No pipeline selected'"></span>
            </div>
        </div>
        <div class="space-y-6">
            {% include 'partials/dashboard/_apriltag_form.html' %}
            {% include 'partials/dashboard/_coloured_shape_form.html' %}
            {% include 'partials/dashboard/_ml_form.html' %}
        </div>
    </div>

    <!-- Pipeline Add/Edit Modal -->
    <div
        class="fixed inset-0 z-50 flex items-center justify-center p-4"
        x-show="pipelineModal.open"
        x-transition
        x-cloak
    >
        <div class="absolute inset-0 bg-black bg-opacity-70" @click="closePipelineModal"></div>
        <div class="relative bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6 space-y-4">
            <h3 class="text-lg font-semibold text-white" x-text="pipelineModal.mode === 'add' ? 'Add Pipeline' : 'Edit Pipeline'"></h3>
            <div class="space-y-3">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">Name</label>
                    <input
                        type="text"
                        class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        x-model="pipelineModal.name"
                        placeholder="Enter pipeline name"
                    >
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">Type</label>
                    <select
                        class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        x-model="pipelineModal.type"
                    >
                        <template x-for="type in pipelineTypes" :key="type">
                            <option :value="type" x-text="type"></option>
                        </template>
                    </select>
                    <p class="text-xs text-gray-400 mt-2" x-show="pipelineModal.mode === 'edit'">
                        Changing the pipeline type will reset its configuration.
                    </p>
                </div>
            </div>
            <div class="flex justify-end gap-3">
                <button
                    type="button"
                    class="px-4 py-2 rounded-md border border-gray-600 text-sm text-gray-200 hover:bg-gray-700"
                    @click="closePipelineModal"
                    :disabled="pipelineModal.saving"
                >
                    Cancel
                </button>
                <button
                    type="button"
                    class="px-4 py-2 rounded-md bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed"
                    @click="submitPipelineModal"
                    :disabled="pipelineModal.saving"
                >
                    <span x-show="!pipelineModal.saving">Save</span>
                    <span x-show="pipelineModal.saving">Saving…</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Pipeline Delete Confirmation -->
    <div
        class="fixed inset-0 z-50 flex items-center justify-center p-4"
        x-show="deleteModal.open"
        x-transition
        x-cloak
    >
        <div class="absolute inset-0 bg-black bg-opacity-70" @click="closeDeleteModal"></div>
        <div class="relative bg-gray-800 rounded-lg shadow-xl w-full max-w-sm p-6 space-y-4">
            <h3 class="text-lg font-semibold text-white">Delete Pipeline</h3>
            <p class="text-sm text-gray-300">
                Are you sure you want to delete
                <span class="font-semibold" x-text="deleteModal.name"></span>?
                This action cannot be undone.
            </p>
            <div class="flex justify-end gap-3">
                <button
                    type="button"
                    class="px-4 py-2 rounded-md border border-gray-600 text-sm text-gray-200 hover:bg-gray-700"
                    @click="closeDeleteModal"
                    :disabled="deleteModal.saving"
                >
                    Cancel
                </button>
                <button
                    type="button"
                    class="px-4 py-2 rounded-md bg-red-600 hover:bg-red-700 text-white text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed"
                    @click="confirmDeletePipeline"
                    :disabled="deleteModal.saving"
                >
                    <span x-show="!deleteModal.saving">Delete</span>
                    <span x-show="deleteModal.saving">Deleting…</span>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
