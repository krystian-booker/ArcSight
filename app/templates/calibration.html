{% extends "layout.html" %}

{% block title %}Camera Calibration{% endblock %}

{% block content %}
<div class="container mx-auto">
    <h1 class="text-3xl font-bold mb-6">Camera Calibration</h1>

    <!-- Step 1: Setup -->
    <div id="setup-step" class="bg-gray-800 p-6 rounded-lg shadow-lg mb-8">
        <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2">Step 1: Setup</h2>
        <form id="setup-form" class="space-y-4">
            <div>
                <label for="camera-select" class="block text-sm font-medium mb-1">Select Camera</label>
                <select id="camera-select" name="camera_id" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">-- Select a Camera --</option>
                    {% for camera in cameras %}
                    <option value="{{ camera.id }}">{{ camera.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="pattern-type" class="block text-sm font-medium mb-1">Pattern Type</label>
                <select id="pattern-type" name="pattern_type" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2">
                    <option value="Chessboard">Chessboard</option>
                    <option value="AprilGrid" disabled>AprilGrid (Not Implemented)</option>
                </select>
            </div>
            <div id="chessboard-params" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label for="pattern-cols" class="block text-sm font-medium mb-1">Inner Corners Width</label>
                    <input type="number" id="pattern-cols" name="pattern_cols" value="7" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2">
                </div>
                <div>
                    <label for="pattern-rows" class="block text-sm font-medium mb-1">Inner Corners Height</label>
                    <input type="number" id="pattern-rows" name="pattern_rows" value="10" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2">
                </div>
                <div>
                    <label for="square-size" class="block text-sm font-medium mb-1">Square Size (mm)</label>
                    <input type="number" id="square-size" name="square_size" value="20" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2">
                </div>
            </div>
             <div class="mt-4 text-center">
                <a href="#" id="download-pattern-link" class="text-blue-400 hover:text-blue-300 hover:underline">Download Chessboard Pattern</a>
            </div>
            <button type="submit" id="start-calibration-btn" class="w-full mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition duration-300">Start Calibration</button>
        </form>
    </div>

    <!-- Step 2: Capture -->
    <div id="capture-step" class="bg-gray-800 p-6 rounded-lg shadow-lg mb-8 hidden">
        <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2">Step 2: Capture</h2>
        <div class="flex flex-col md:flex-row gap-6">
            <div class="flex-grow">
                <img id="calibration-feed" src="" alt="Calibration Feed" class="w-full rounded-md bg-black">
            </div>
            <div class="md:w-1/3 flex flex-col space-y-4">
                <p class="text-gray-400">Show the pattern at different angles and distances. Capture at least 15 images for good results.</p>
                <button id="capture-frame-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md">Capture Frame</button>
                <div class="text-center">
                    <p class="text-lg">Images Captured: <span id="capture-count">0</span></p>
                </div>
                <button id="calculate-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-md disabled:bg-gray-500 disabled:cursor-not-allowed" disabled>Calculate Intrinsics</button>
            </div>
        </div>
    </div>

    <!-- Step 3: Results -->
    <div id="results-step" class="bg-gray-800 p-6 rounded-lg shadow-lg hidden">
        <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2">Step 3: Results</h2>
        <div id="results-content" class="space-y-4">
             <div>
                <label class="block text-sm font-medium">Reprojection Error:</label>
                <p id="reprojection-error" class="text-lg font-mono p-2 bg-gray-700 rounded"></p>
            </div>
            <div>
                <label class="block text-sm font-medium">Camera Matrix (fx, fy, cx, cy):</label>
                <pre id="camera-matrix" class="text-sm font-mono p-2 bg-gray-700 rounded"></pre>
            </div>
            <div>
                <label class="block text-sm font-medium">Distortion Coefficients:</label>
                <pre id="dist-coeffs" class="text-sm font-mono p-2 bg-gray-700 rounded"></pre>
            </div>
        </div>
        <div class="flex gap-4 mt-6">
            <button id="save-btn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Save to Camera</button>
            <button id="restart-btn" class="flex-1 bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md">Discard and Restart</button>
        </div>
    </div>

    <!-- Status/Notification Area -->
    <div id="status-area" class="mt-4 p-3 bg-gray-700 rounded-md text-center hidden"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const setupStep = document.getElementById('setup-step');
    const captureStep = document.getElementById('capture-step');
    const resultsStep = document.getElementById('results-step');

    const setupForm = document.getElementById('setup-form');
    const cameraSelect = document.getElementById('camera-select');
    const patternColsEl = document.getElementById('pattern-cols');
    const patternRowsEl = document.getElementById('pattern-rows');
    const squareSizeEl = document.getElementById('square-size');
    const downloadLink = document.getElementById('download-pattern-link');
    const startBtn = document.getElementById('start-calibration-btn');
    
    const calibrationFeed = document.getElementById('calibration-feed');
    const captureBtn = document.getElementById('capture-frame-btn');
    const captureCountSpan = document.getElementById('capture-count');
    const calculateBtn = document.getElementById('calculate-btn');

    const reprojectionErrorEl = document.getElementById('reprojection-error');
    const cameraMatrixEl = document.getElementById('camera-matrix');
    const distCoeffsEl = document.getElementById('dist-coeffs');
    const saveBtn = document.getElementById('save-btn');
    const restartBtn = document.getElementById('restart-btn');

    const statusArea = document.getElementById('status-area');

    let state = {
        cameraId: null,
        results: null
    };

    function showStatus(message, isError = false) {
        statusArea.textContent = message;
        statusArea.className = `mt-4 p-3 rounded-md text-center ${isError ? 'bg-red-500' : 'bg-blue-500'}`;
        statusArea.classList.remove('hidden');
    }

    function hideStatus() {
        statusArea.classList.add('hidden');
    }

    function resetUI() {
        state.cameraId = null;
        state.results = null;

        setupStep.classList.remove('hidden');
        captureStep.classList.add('hidden');
        resultsStep.classList.add('hidden');

        setupForm.reset();
        calibrationFeed.src = '';
        captureCountSpan.textContent = '0';
        calculateBtn.disabled = true;
        hideStatus();
    }

    function updateDownloadLink() {
        const rows = patternRowsEl.value;
        const cols = patternColsEl.value;
        const squareSize = squareSizeEl.value;
        downloadLink.href = `/calibration/generate_pattern?rows=${rows}&cols=${cols}&square_size=${squareSize}`;
    }

    // --- Step 1: Setup ---
    patternColsEl.addEventListener('input', updateDownloadLink);
    patternRowsEl.addEventListener('input', updateDownloadLink);
    squareSizeEl.addEventListener('input', updateDownloadLink);
    updateDownloadLink(); // Set initial link

    setupForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(setupForm);
        state.cameraId = formData.get('camera_id');

        if (!state.cameraId) {
            showStatus('Please select a camera.', true);
            return;
        }

        const payload = {
            camera_id: parseInt(state.cameraId),
            pattern_type: formData.get('pattern_type'),
            pattern_rows: formData.get('pattern_rows'),
            pattern_cols: formData.get('pattern_cols'),
            square_size: formData.get('square_size')
        };

        try {
            const response = await fetch('/calibration/start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) throw new Error('Failed to start session.');
            
            const data = await response.json();
            if (data.success) {
                setupStep.classList.add('hidden');
                captureStep.classList.remove('hidden');
                calibrationFeed.src = `/calibration_feed/${state.cameraId}`;
                showStatus('Calibration session started. Begin capturing frames.');
            } else {
                showStatus(data.error, true);
            }
        } catch (err) {
            showStatus(err.message, true);
        }
    });

    // --- Step 2: Capture ---
    captureBtn.addEventListener('click', async () => {
        try {
            const response = await fetch('/calibration/capture', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ camera_id: state.cameraId })
            });

            if (!response.ok) throw new Error('Capture request failed.');
            
            const data = await response.json();
            if (data.success) {
                captureCountSpan.textContent = data.capture_count;
                showStatus(`Frame captured successfully. Total: ${data.capture_count}`);
                if (data.capture_count >= 15) {
                    calculateBtn.disabled = false;
                }
            } else {
                showStatus(data.message || 'Pattern not found in frame.', true);
            }
        } catch (err) {
            showStatus(err.message, true);
        }
    });

    calculateBtn.addEventListener('click', async () => {
        showStatus('Calculating... This may take a moment.');
        try {
            const response = await fetch('/calibration/calculate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ camera_id: state.cameraId })
            });

            if (!response.ok) throw new Error('Calculation request failed.');
            
            const data = await response.json();
            if (data.success) {
                state.results = data;
                displayResults(data);
                captureStep.classList.add('hidden');
                resultsStep.classList.remove('hidden');
                calibrationFeed.src = ''; // Stop the feed
                showStatus('Calculation complete. Review the results below.');
            } else {
                showStatus(data.error, true);
            }
        } catch (err) {
            showStatus(err.message, true);
        }
    });

    // --- Step 3: Results ---
    function displayResults(data) {
        const error = data.reprojection_error;
        reprojectionErrorEl.textContent = error.toFixed(4);
        reprojectionErrorEl.style.color = error < 1.0 ? '#4ade80' : '#f87171'; // green-400 or red-400

        const matrix = JSON.parse(data.camera_matrix);
        const dist = JSON.parse(data.dist_coeffs);

        cameraMatrixEl.textContent = `fx: ${matrix[0][0].toFixed(2)}, fy: ${matrix[1][1].toFixed(2)}\ncx: ${matrix[0][2].toFixed(2)}, cy: ${matrix[1][2].toFixed(2)}`;
        distCoeffsEl.textContent = JSON.stringify(dist, null, 2);
    }

    saveBtn.addEventListener('click', async () => {
        if (!state.results) {
            showStatus('No results to save.', true);
            return;
        }

        const payload = {
            camera_id: state.cameraId,
            ...state.results
        };

        showStatus('Saving...');
        try {
            const response = await fetch('/calibration/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) throw new Error('Save request failed.');
            
            const data = await response.json();
            if (data.success) {
                showStatus('Calibration data saved successfully! The camera thread is restarting to apply changes.');
                setTimeout(resetUI, 3000);
            } else {
                showStatus(data.error, true);
            }
        } catch (err) {
            showStatus(err.message, true);
        }
    });

    restartBtn.addEventListener('click', () => {
        resetUI();
    });
});
</script>
{% endblock %}