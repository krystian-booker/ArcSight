{% extends "layout.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<h1 class="text-3xl font-bold mb-4">Dashboard</h1>

<div class="mb-4">
    <label for="camera-select" class="block text-sm font-medium text-gray-300 mb-2">Select Camera</label>
    <select id="camera-select" class="custom-select">
        {% if cameras %}
            {% for camera in cameras %}
                <option value="{{ camera.id }}">{{ camera.name }}</option>
            {% endfor %}
        {% else %}
            <option value="">No cameras configured</option>
        {% endif %}
    </select>
</div>

<div class="bg-gray-800 rounded-lg p-4">
    <div class="camera-feed-container bg-black h-96 flex items-center justify-center rounded">
        {% if cameras %}
            <img id="camera-feed" src="" alt="Camera Feed" class="max-h-full max-w-full">
        {% else %}
            <p class="text-gray-500">No camera feed available.</p>
        {% endif %}
    </div>
</div>

{% if cameras %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const cameraSelect = document.getElementById('camera-select');
        const feedContainer = document.querySelector('.camera-feed-container');
        let cameraFeed = document.getElementById('camera-feed');

        function updateCameraFeed(cameraId) {
            if (!cameraId) {
                feedContainer.innerHTML = '<p class="text-gray-500">No camera selected.</p>';
                return;
            }

            // Check camera status first
            fetch(`/api/cameras/status/${cameraId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.connected) {
                        const newFeedUrl = `/video_feed/${cameraId}?t=${new Date().getTime()}`;
                        const existingImg = document.getElementById('camera-feed');
                        
                        if (existingImg) {
                            existingImg.src = newFeedUrl;
                        } else {
                            feedContainer.innerHTML = `<img id="camera-feed" src="${newFeedUrl}" alt="Camera Feed" class="max-h-full max-w-full">`;
                        }
                    } else {
                        feedContainer.innerHTML = '<p class="text-red-500">Camera is not connected.</p>';
                    }
                })
                .catch(error => {
                    console.error('Error checking camera status:', error);
                    feedContainer.innerHTML = '<p class="text-red-500">Error checking camera status.</p>';
                });
        }

        // Set the initial camera feed
        const initialCameraId = cameraSelect.value;
        updateCameraFeed(initialCameraId);

        // Handle camera selection changes
        cameraSelect.addEventListener('change', function() {
            updateCameraFeed(this.value);
        });
    });
</script>
{% endif %}
{% endblock %}
